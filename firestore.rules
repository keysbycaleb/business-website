rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'caleb@lantingdigital.com';
    }

    // Existing contacts collection (keep for backwards compatibility)
    match /contacts/{contactId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null;
    }

    // New submissions collection - anyone can create, only authenticated users can manage
    match /submissions/{submissionId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null;
    }

    // Archived submissions - authenticated users only
    match /archived-submissions/{submissionId} {
      allow read, create, update, delete: if request.auth != null;
    }

    // Forms config - anyone can read (for email recipients), no one can write (console only)
    match /forms/{formId} {
      allow read: if true;
      allow write: if false;
    }

    // Contracts collection - anyone can read and update (for signing), only auth users can create/delete
    match /contracts/{contractId} {
      // Anyone can read a contract (needed for signing page)
      allow read: if true;
      // Anyone can update specific fields (for signing)
      allow update: if true;
      // Only authenticated users can create or delete
      allow create, delete: if request.auth != null;
    }

    // Clients collection
    match /clients/{clientId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own record (matched by email)
      allow read: if request.auth != null && resource.data.email == request.auth.token.email;
      // Clients can update their own record (limited fields)
      allow update: if request.auth != null && resource.data.email == request.auth.token.email;
    }

    // Messages collection
    match /messages/{messageId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own messages
      allow read: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
      // Clients can create messages (to admin)
      allow create: if request.auth != null && request.resource.data.clientEmail == request.auth.token.email;
      // Clients can update read status on their messages
      allow update: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
    }

    // Invoices collection
    match /invoices/{invoiceId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own invoices
      allow read: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
    }

    // Settings collection (admin status, etc.)
    match /settings/{settingId} {
      // Anyone authenticated can read settings (for admin status display)
      allow read: if request.auth != null;
      // Only admin can write settings
      allow write: if isAdmin();
    }

    // Subscriptions collection
    match /subscriptions/{subscriptionId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own subscriptions
      allow read: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
    }

    // Payment Plans collection
    match /paymentPlans/{planId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own payment plans
      allow read: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
    }

    // Payments collection (tracks individual payments)
    match /payments/{paymentId} {
      // Admin can do everything
      allow read, create, update, delete: if isAdmin();
      // Clients can read their own payments
      allow read: if request.auth != null && resource.data.clientEmail == request.auth.token.email;
    }

    // Auth tokens collection (password reset, invitations)
    // Only Cloud Functions can read/write (no client access)
    // This ensures tokens are secure and managed server-side only
    match /authTokens/{tokenId} {
      allow read, write: if false;
    }
  }
}
